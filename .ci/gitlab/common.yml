.common:
  image: docker.pkg.github.com/clash-lang/clash-compiler/clash-ci-$GHC_VERSION:2021-11-25
  timeout: 2 hours
  stage: build
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    TERM: xterm-color
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  cache:
    key: cabal-store-$CI_JOB_NAME-$GHC_VERSION
    when: always
    paths:
      - /root/cache.tar.zst
  before_script:
    - export THREADS=$(./.ci/effective_cpus.sh)
    - export CABAL_JOBS=$(./.ci/effective_cpus.sh)
    - export
    - tar -xf /root/cache.tar.zst -C / || true
    - rm /root/cache.tar.zst
    - .ci/setup.sh
  after_script:
    - tar --remove-files -cf - $(ls -d /root/.cabal /root/.stack $(pwd)/.ci/bindist/linux/debian/*/build || true) | zstd -T${THREADS} -3 > /root/cache.tar.zst
  tags:
    - local
